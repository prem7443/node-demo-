name: Auto-Close Conflicted PRs

on:
  pull_request:
    types:
      - opened
      - synchronize
      - reopened


permissions:
  pull-requests: write
  contents: read

jobs:
  close_conflicted_prs:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: List all open PRs
        id: list_prs
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const prs = await github.rest.pulls.list({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              per_page: 100,
            });
            // Output PR numbers as JSON string
            return prs.data.map(pr => pr.number);

      - name: Process each PR
        id: process_prs
        run: |
          echo "${{ steps.list_prs.outputs.result }}" > pr_numbers.json
          prs=$(cat pr_numbers.json | jq -r '.[]')

          for pr in $prs; do
            echo "Checking PR #$pr..."

            for i in {1..10}; do
              pr_data=$(curl -s -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
                https://api.github.com/repos/${{ github.repository }}/pulls/$pr)
              mergeable=$(echo "$pr_data" | jq -r '.mergeable')

              if [[ "$mergeable" != "null" ]]; then
                break
              fi
              echo "Waiting for mergeable to be computed for PR #$pr... attempt $i"
              sleep 3
            done

            if [[ "$mergeable" == "false" ]]; then
              echo "Closing PR #$pr due to merge conflicts..."

              # Post a comment
              curl -s -X POST -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
                -H "Content-Type: application/json" \
                -d '{"body":"‚ùå This pull request has a merge conflict and was automatically closed."}' \
                https://api.github.com/repos/${{ github.repository }}/issues/$pr/comments

              # Close the PR
              curl -s -X PATCH -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
                -H "Content-Type: application/json" \
                -d '{"state":"closed"}' \
                https://api.github.com/repos/${{ github.repository }}/pulls/$pr
            else
              echo "PR #$pr is mergeable."
            fi
          done
