name: Auto-Close Conflicted PRs

on:
  pull_request:
    types: [opened, synchronize, reopened]

permissions:
  pull-requests: write
  contents: read

jobs:
  close_conflicted_pr:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Check and close conflicted PR
        run: |
          pr=${{ github.event.pull_request.number }}
          echo "Checking PR #$pr..."

          for i in {1..10}; do
            pr_data=$(curl -s -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
              https://api.github.com/repos/${{ github.repository }}/pulls/$pr)
            mergeable=$(echo "$pr_data" | jq -r '.mergeable')

            if [[ "$mergeable" != "null" ]]; then
              break
            fi
            echo "Waiting for mergeable to be computed for PR #$pr... attempt $i"
            sleep 3
          done

          if [[ "$mergeable" == "false" ]]; then
            echo "Closing PR #$pr due to merge conflicts..."
            curl -s -X POST -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
              -H "Content-Type: application/json" \
              -d '{"body":"‚ùå This pull request has a merge conflict and was automatically closed."}' \
              https://api.github.com/repos/${{ github.repository }}/issues/$pr/comments

            curl -s -X PATCH -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
              -H "Content-Type: application/json" \
              -d '{"state":"closed"}' \
              https://api.github.com/repos/${{ github.repository }}/pulls/$pr
          else
            echo "PR #$pr is mergeable."
          fi
